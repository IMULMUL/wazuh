---
test_name: GET DECODERS RBAC

marks:
  - usefixtures:
    - decoders_white_rbac_tests

includes:
  - !include common.yaml

stages:
  - type: ref
    id: login_get_token

  - name: Try to show the decoders of the system
    request:
      url: "{protocol:s}://{host:s}:{port:d}/decoders"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
      params:
        limit: 5
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - details:
                prematch: "^wazuh: "
              file: 0005-wazuh_decoders.xml
              name: wazuh
              path: ruleset/decoders
              position: 0
              status: enabled
            - details:
                order: level
                parent: wazuh
                prematch: "^Agent buffer:"
                regex:
                  - "^ '(\\S+)'."
              file: 0005-wazuh_decoders.xml
              name: agent-buffer
              path: ruleset/decoders
              position: 1
              status: enabled
            - details:
                order: agent.id, agent.name, status
                parent: wazuh
                prematch: "^Upgrade procedure |^Custom installation "
                regex:
                  - on agent (\d\d\d)\s\((\S+)\):\s(\w+)
              file: 0005-wazuh_decoders.xml
              name: agent-upgrade
              path: ruleset/decoders
              position: 2
              status: enabled
            - details:
                order: error
                parent: wazuh
                regex:
                  - aborted:\s(\.+)$|failed:\s(\.+)$|lost:\s(\.+)$
              file: 0005-wazuh_decoders.xml
              name: agent-upgrade
              path: ruleset/decoders
              position: 3
              status: enabled
            - details:
                order: agent.cur_version
                parent: wazuh
                regex:
                  - started.\sCurrent\sversion:\sWazuh\s(\.+)$
              file: 0005-wazuh_decoders.xml
              name: agent-upgrade
              path: ruleset/decoders
              position: 4
              status: enabled
          failed_items: []
          total_affected_items: 21
          total_failed_items: 0
        message: All selected decoders were shown

  - name: Try to show the decoders of the system (list)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/decoders"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
      params:
        decoder_names: wazuh,agent-buffer,netscaler,netinfo,agent-upgrade
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - details:
                prematch: "^wazuh: "
              file: 0005-wazuh_decoders.xml
              name: wazuh
              path: ruleset/decoders
              position: 0
              status: enabled
            - details:
                order: level
                parent: wazuh
                prematch: "^Agent buffer:"
                regex:
                  - "^ '(\\S+)'."
              file: 0005-wazuh_decoders.xml
              name: agent-buffer
              path: ruleset/decoders
              position: 1
              status: enabled
            - details:
                order: agent.id, agent.name, status
                parent: wazuh
                prematch: "^Upgrade procedure |^Custom installation "
                regex:
                  - on agent (\d\d\d)\s\((\S+)\):\s(\w+)
              file: 0005-wazuh_decoders.xml
              name: agent-upgrade
              path: ruleset/decoders
              position: 2
              status: enabled
            - details:
                order: error
                parent: wazuh
                regex:
                  - aborted:\s(\.+)$|failed:\s(\.+)$|lost:\s(\.+)$
              file: 0005-wazuh_decoders.xml
              name: agent-upgrade
              path: ruleset/decoders
              position: 3
              status: enabled
            - details:
                order: agent.cur_version
                parent: wazuh
                regex:
                  - started.\sCurrent\sversion:\sWazuh\s(\.+)$
              file: 0005-wazuh_decoders.xml
              name: agent-upgrade
              path: ruleset/decoders
              position: 4
              status: enabled
            - details:
                order: agent.new_version
                parent: wazuh
                regex:
                  - succeeded.\sNew\sversion:\sWazuh\s(\.+)$
              file: 0005-wazuh_decoders.xml
              name: agent-upgrade
              path: ruleset/decoders
              position: 5
              status: enabled
            - details:
                prematch: "\\d\\d/\\d\\d/\\d\\d\\d\\d:\\s*\\d\\d:\\d\\d:\\d\\d\\s+GMT\\s+\\S+\\.+PPE\\.+:\\s|\\d\\d/\\d\\d/\\d\\d\\d\\d:\\s*\\d\\d:\\d\\d:\\d\\d\\s+GMT\\s+ns\\.+:\\s"
              file: 0160-netscaler_decoders.xml
              name: netscaler
              path: ruleset/decoders
              position: 0
              status: enabled
          failed_items:
            - error:
                code: 1504
                message: !anystr
                remediation: !anystr
              id:
                - netinfo
          total_affected_items: 7
          total_failed_items: 1
        message: Some decoders could not be shown

---
test_name: GET DECODERS FILES RBAC

stages:

  - name: Try to show the decoders files of the system
    request:
      url: "{protocol:s}://{host:s}:{port:d}/decoders/files"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - file: 0005-wazuh_decoders.xml
              path: ruleset/decoders
              status: enabled
            - file: 0160-netscaler_decoders.xml
              path: ruleset/decoders
              status: enabled
          failed_items: []
          total_affected_items: 2
          total_failed_items: 0
        message: All rules files were shown

  - name: Try to show the decoders files of the system (list)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/decoders/files"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
      params:
        file: 0005-wazuh_decoders.xml,0160-netscaler_decoders.xml
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - file: 0005-wazuh_decoders.xml
              path: ruleset/decoders
              status: enabled
            - file: 0160-netscaler_decoders.xml
              path: ruleset/decoders
              status: enabled
          failed_items: []
          total_affected_items: 2
          total_failed_items: 0
        message: All rules files were shown

  - name: Try to show the decoders files of the system (no permissions)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/decoders/files"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
      params:
        file: 0064-cisco-asa_decoders.xml,0100-fortigate_decoders.xml
    response:
      status_code: 400
      body: &permissions_denied
        code: 4000
        dapi_errors:
          master-node:
            error: Permission denied
        detail: Permission denied
        remediation: Please, make sure you have permissions to execute current request, for
          more information on setting up permissions please visit XXXX
        status: 400
        title: Wazuh Error
        type: about:blank

---
test_name: GET DECODERS FILES RBAC (Download)

stages:

  - name: Try get one decoder file
    request:
      url: "{protocol:s}://{host:s}:{port:d}/decoders/files/0005-wazuh_decoders.xml/download"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200

  - name: Try get one decoder file (no permissions)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/decoders/files/0064-cisco-asa_decoders.xml/download"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body:
        <<: *permissions_denied

---
test_name: GET DECODERS PARENTS RBAC

stages:

  - name: Try to show the groups of rules in the system
    request:
      url: "{protocol:s}://{host:s}:{port:d}/decoders/parents"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200
      body:
        data:
          affected_items: !anything
          failed_items: []
          total_affected_items: 2
          total_failed_items: 0
        message: All selected decoders were shown
